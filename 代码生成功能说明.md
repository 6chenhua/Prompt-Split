# 代码生成功能说明

## 概述

我已经成功将 `gen_code` 目录中的代码生成功能融入到现有的项目流程中。现在在第二步生成子提示词后，系统会自动尝试为每个子系统生成相应的Python代码实现。

## 新增功能

### 1. 代码生成模块 (`code_generator.py`)

新创建的代码生成器包含以下功能：

- **可实现性判断**：分析子提示词是否适合用代码实现
- **代码生成**：根据需求生成Python代码
- **测试用例生成**：为生成的代码创建测试用例
- **批量处理**：一次性处理所有子系统

### 2. 集成到现有流程

代码生成功能被集成为"第2.5步"，在以下位置执行：

```
第一步：提取变量
第二步：拆分子系统和生成子提示词
第2.5步：代码生成 ← 新增
第三步：转换为CNLP格式
```

### 3. UI界面更新

Web界面 (`ui_streamlit.py`) 已更新：

- 新增"代码生成"步骤显示
- 专门的代码生成结果展示区域
- 显示可实现性判断、生成的代码和测试用例
- 更新的统计信息和报告

## 使用方法

### 1. 命令行方式

```bash
# 运行完整流程（包含代码生成）
python run_split.py

# 测试代码生成功能
python test_code_generation.py
```

### 2. Web界面方式

```bash
# 启动Web界面
streamlit run ui_streamlit.py
```

在Web界面中，代码生成步骤会自动执行，您可以在进度条中看到"代码生成 💻"步骤。

### 3. 直接使用代码生成器

```python
from code_generator import CodeGenerator

# 创建代码生成器
generator = CodeGenerator()

# 判断可实现性
judgment = generator.judge_implementability("编写一个计算器函数")

# 生成代码
if judgment["is_implementable"]:
    code = generator.generate_code(
        requirement="编写一个计算器函数",
        annotation=judgment["annotation"]
    )
    
    # 生成测试用例
    test_cases = generator.generate_test_cases(
        requirement="编写一个计算器函数",
        code=code,
        num_cases=5
    )
```

## 输出文件

代码生成功能会创建以下输出文件：

1. **`output_step2_5_code.json`** - 完整的代码生成结果
2. **`gen_code/output/code_generation_results.json`** - 详细的代码生成报告
3. **`gen_code/output/子系统名_N.py`** - 为每个成功生成代码的子系统创建的Python文件

## 功能特点

### 1. 智能判断

系统会首先判断每个子提示词是否适合用代码实现：

- ✅ **适合实现**：逻辑清晰、可编程的功能
- ❌ **不适合实现**：创意写作、情感表达等非编程任务

### 2. 代码生成

对于适合实现的子系统，会生成：

- 完整的Python函数或类
- 详细的文档字符串
- 错误处理逻辑
- 符合PEP 8规范的代码

### 3. 测试用例

自动生成多样化的测试用例：

- 正常输入测试
- 边界值测试
- 异常情况测试
- 预期输出验证

### 4. 结果可视化

在Web界面中可以看到：

- 📊 统计信息（总数、可实现数、成功数等）
- 🔍 每个子系统的详细结果
- 💻 生成的代码（语法高亮）
- 🧪 测试用例展示
- 📝 原始提示词查看

## 配置选项

代码生成功能使用现有的LLM配置，支持：

- 自定义API密钥
- 自定义API基础URL
- 自定义模型名称

## 错误处理

代码生成功能具有良好的容错性：

- 即使代码生成失败，也不会中断整个流程
- 会记录详细的错误信息和原因
- 支持部分成功（某些子系统生成成功，某些失败）

## 示例输出

以下是一个典型的代码生成结果示例：

```json
{
  "results": [
    {
      "name": "数学计算器",
      "is_implementable": true,
      "annotation": "创建一个函数，接收两个数字和运算符，返回计算结果",
      "code": "def calculator(num1, operator, num2):\n    if operator == '+':\n        return num1 + num2\n    elif operator == '-':\n        return num1 - num2\n    # ...",
      "test_cases": [
        {
          "input_code": "print(calculator(2, '+', 3))",
          "expected_output": "5"
        }
      ]
    }
  ],
  "summary": {
    "total_subprompts": 3,
    "implementable_count": 2,
    "successful_count": 2,
    "failed_count": 1
  }
}
```

## 技术实现

### 架构设计

代码生成功能采用模块化设计：

- **CodeGenerator类**：核心代码生成逻辑
- **三个专门的提示词模板**：判断、生成、测试
- **智能JSON解析**：处理LLM响应的多种格式
- **文件管理**：自动保存和组织生成的代码

### 提示词模板

使用了三个专门优化的提示词模板：

1. **JUDGE模板**：判断需求是否可编程实现
2. **CODE模板**：生成高质量的Python代码
3. **CASE模板**：创建全面的测试用例

### 集成方式

代码生成功能以最小侵入性方式集成：

- 新增独立的模块文件
- 在现有流程中插入新步骤
- 保持向后兼容性
- 支持优雅降级（代码生成失败不影响其他步骤）

## 下一步计划

您可以根据需要进一步扩展功能：

1. **支持更多编程语言**（JavaScript、Java等）
2. **代码质量评估**（静态分析、复杂度检查）
3. **自动代码执行和验证**
4. **代码优化建议**
5. **集成到CI/CD流程**

---

现在您的项目已经具备了完整的代码生成能力！🎉 